"use strict";var ApplicationConfiguration=function(){var applicationModuleName="jackfruit-server",applicationModuleVendorDependencies=["ngResource","ngCookies","ngAnimate","ngTouch","ngSanitize","ui.router","ui.bootstrap","ui.utils"],registerModule=function(moduleName,dependencies){angular.module(moduleName,dependencies||[]),angular.module(applicationModuleName).requires.push(moduleName)};return{applicationModuleName:applicationModuleName,applicationModuleVendorDependencies:applicationModuleVendorDependencies,registerModule:registerModule}}();angular.module(ApplicationConfiguration.applicationModuleName,ApplicationConfiguration.applicationModuleVendorDependencies),angular.module(ApplicationConfiguration.applicationModuleName).config(["$locationProvider",function($locationProvider){$locationProvider.hashPrefix("!")}]),angular.element(document).ready(function(){"#_=_"===window.location.hash&&(window.location.hash="#!"),angular.bootstrap(document,[ApplicationConfiguration.applicationModuleName])}),ApplicationConfiguration.registerModule("activity"),ApplicationConfiguration.registerModule("areas"),ApplicationConfiguration.registerModule("banners"),ApplicationConfiguration.registerModule("cities"),ApplicationConfiguration.registerModule("core"),ApplicationConfiguration.registerModule("countries"),ApplicationConfiguration.registerModule("objection-reports"),ApplicationConfiguration.registerModule("provinces"),ApplicationConfiguration.registerModule("quota-recorders"),ApplicationConfiguration.registerModule("scenic-areas"),ApplicationConfiguration.registerModule("scenic-spots"),ApplicationConfiguration.registerModule("task-lists"),ApplicationConfiguration.registerModule("tasks"),ApplicationConfiguration.registerModule("user-feedbacks"),ApplicationConfiguration.registerModule("user-management"),ApplicationConfiguration.registerModule("users"),angular.module("activity").run(["Menus",function(Menus){Menus.addMenuItem("topbar","我的活动","activities","dropdown","/banners(/create)?",!1,["tenant"],13),Menus.addSubMenuItem("topbar","activities","我的活动列表","my-activity-list")}]),angular.module("activity").config(["$stateProvider",function($stateProvider){$stateProvider.state("listActivity",{url:"/my-activity-list",templateUrl:"modules/activity/views/my-activity-list.client.view.html"}).state("activity",{url:"/my-activity/:activityId",templateUrl:"modules/activity/views/my-activity.client.view.html"})}]),angular.module("activity").controller("ActivityController",["$scope","$stateParams","$location","Authentication","Tasks","TasksVerify","TasksGrant","$http",function($scope,$stateParams,$location,Authentication,Tasks,TaskVerify,TaskGrant,$http){$scope.authentication=Authentication,$scope.before=function(){$http.get("/quota-recorders/tasks/"+$stateParams.activityId+"/auth-tenant").success(function(date){date.result===!0&&($scope.quotaRecordFlag="您的申请已经发送")}).error(function(data){window.alert(data.message)})},$scope.findMyTasks=function(){Tasks.get({belongToUser:$scope.authentication.user.id,pageSize:500}).$promise.then(function(result){0===result.statusCode?$scope.tasks=result.tasks:($scope.error=result.message,window.alert(result.message))})},$scope.findOne=function(){Tasks.get({taskId:$stateParams.activityId}).$promise.then(function(result){$scope.task=result.task})},$scope.verifyUser=function(){TaskVerify.save({id:$stateParams.activityId,verifyCode:$scope.verifyCode}).$promise.then(function(result){window.alert(result.message)},function(result){window.alert(result.data.message)})},$scope.grantBonus=function(result){TaskGrant.save({id:$stateParams.activityId,verifyCode:$scope.verifyCode,result:result}).$promise.then(function(result){0===result.statusCode?window.alert("操作成功！"):92e3===result.statusCode?window.alert("请输入验证码！"):54e3===result.statusCode&&window.alert("验证码错误！")},function(result){window.alert("服务器内部错误，请稍后再试。")})},$scope.applyForQuota=function(){/^\+?[1-9][0-9]*$/.test($scope.quantity)?$http.post("/tasks/"+$stateParams.activityId+"/apply-for-quota",{quantity:$scope.quantity}).success(function(){$scope.quotaRecordFlag="您的申请已经发送",window.alert("发送申请成功，管理员会尽快审核~")}).error(function(data){window.alert(data.message)}):window.alert("请输入正确的数量！")}}]),angular.module("areas").run(["Menus",function(Menus){Menus.addMenuItem("topbar","区域","areas","dropdown","/areas(/create)?",!1,["unavaliable"],7),Menus.addSubMenuItem("topbar","areas","添加区域","areas/create")}]),angular.module("areas").config(["$stateProvider",function($stateProvider){$stateProvider.state("createAreas",{url:"/areas/create",templateUrl:"modules/areas/views/create-areas.client.view.html"})}]),angular.module("areas").controller("AreasController",["$scope","$http","$stateParams","$location","Authentication","Cities","Countries",function($scope,$http,$stateParams,$location,Authentication,Cities,Countries){$scope.authentication=Authentication,$scope.newArea={},$scope.create=function(){$http.post("/areas",{area:$scope.newArea}).success(function(data){0===data.statusCode?(window.alert("创建成功"),$location.path("cities/"+$scope.newArea.city)):window.alert(data.message)})},$scope.getCountries=function(){Countries.get().$promise.then(function(result){$scope.countries=result.countries})},$scope.getProvinces=function(){$http.get("countries/"+this.country+"/provinces").success(function(data){$scope.provinces=data.provinces})},$scope.getCities=function(){$http.get("provinces/"+$scope.newArea.province+"/cities").success(function(data){$scope.cities=data.cities})}}]),angular.module("banners").run(["Menus",function(Menus){Menus.addMenuItem("topbar","Banners","banners","dropdown","/banners(/create)?",!1,["admin"],1),Menus.addSubMenuItem("topbar","banners","Banners列表","banners"),Menus.addSubMenuItem("topbar","banners","创建Banner","banners/create")}]),angular.module("banners").config(["$stateProvider",function($stateProvider){$stateProvider.state("listBanners",{url:"/banners",templateUrl:"modules/banners/views/list-banners.client.view.html"}).state("createBanner",{url:"/banners/create",templateUrl:"modules/banners/views/create-banner.client.view.html"}).state("viewBanner",{url:"/banners/:bannerId",templateUrl:"modules/banners/views/view-banner.client.view.html"}).state("editBanner",{url:"/banners/:bannerId/edit",templateUrl:"modules/banners/views/edit-banner.client.view.html"})}]),angular.module("banners").controller("BannersController",["$scope","$stateParams","$location","Authentication","Banners","$http",function($scope,$stateParams,$location,Authentication,Banners,$http){$scope.authentication=Authentication,$scope.create=function(){var banner=new Banners({title:this.title,subTitle:this.subTitle,url:this.bannerUrl,coverUrl:this.coverUrl});banner.$save(function(response){$location.path("banners/"+response._id),$scope.name=""},function(errorResponse){$scope.error=errorResponse.data.message})},$scope.remove=function(){$scope.bannerToDelete&&$http["delete"]("banners/"+$scope.bannerToDelete._id).then(function(data){for(var i in $scope.banners)$scope.banners[i]===$scope.bannerToDelete&&($scope.banners.splice(i,1),window.alert("banner"+$scope.bannerToDelete.title+"删除成功！"),$scope.bannerToDelete=void 0)})},$scope.setBannerToDelete=function(banner){$scope.bannerToDelete=banner},$scope.update=function(){var banner=$scope.banner;banner.$update(function(){$location.path("banners/"+banner._id)},function(errorResponse){$scope.error=errorResponse.data.message})},$scope.find=function(){$http.get("banners").success(function(data){$scope.banners=data.banners}).error(function(err){$scope.error=err.message})},$scope.findOne=function(){Banners.get({bannerId:$stateParams.bannerId}).$promise.then(function(result){$scope.banner=result.banner})},$scope.initCreateUploadController=function(update){var uploader=Qiniu.uploader({runtimes:"html5,flash,html4",browse_button:"pickfiles",container:"container",drop_element:"container",flash_swf_url:"lib/plupload/js/Moxie.swf",chunk_size:"4mb",uptoken_url:"/qiniu/banner-image-upload-token",domain:"http://7xijtn.com1.z0.glb.clouddn.com/",save_key:!0,max_file_size:"1024kb",filters:[{title:"Image files",extensions:"jpg,jpeg,gif,png"}],x_vars:{bannerId:$stateParams.bannerId},auto_start:!0,init:{FilesAdded:function(up,files){$("table").show(),$("#success").hide(),plupload.each(files,function(file){var progress=new FileProgress(file,"fsUploadProgress");progress.setStatus("等待...")})},BeforeUpload:function(up,file){var progress=new FileProgress(file,"fsUploadProgress"),chunk_size=plupload.parseSize(this.getOption("chunk_size"));"html5"===up.runtime&&chunk_size&&progress.setChunkProgess(chunk_size)},UploadProgress:function(up,file){var progress=new FileProgress(file,"fsUploadProgress"),chunk_size=plupload.parseSize(this.getOption("chunk_size"));progress.setProgress(file.percent+"%",up.total.bytesPerSec,chunk_size)},UploadComplete:function(){$("#success").show()},FileUploaded:function(up,file,info){var infoObj=JSON.parse(info);update?$scope.banner.coverUrl=infoObj.key:$scope.coverUrl=infoObj.key,$scope.$apply();var progress=new FileProgress(file,"fsUploadProgress");progress.setComplete(up,info)},Error:function(up,err,errTip){$("table").show();var progress=new FileProgress(err.file,"fsUploadProgress");progress.setError(),progress.setStatus(errTip)}}});uploader.bind("FileUploaded",function(){})}}]),angular.module("banners").factory("Banners",["$resource",function($resource){return $resource("banners/:bannerId",{bannerId:"@_id"},{update:{method:"PUT"}})}]),angular.module("cities").run(["Menus",function(Menus){Menus.addMenuItem("topbar","城市","cities","dropdown","/cities(/create)?",!1,["editor","admin"],6),Menus.addSubMenuItem("topbar","cities","查看所有城市","cities"),Menus.addSubMenuItem("topbar","cities","查看热门城市","cities/hot"),Menus.addSubMenuItem("topbar","cities","添加城市","cities/create")}]),angular.module("cities").config(["$stateProvider",function($stateProvider){$stateProvider.state("listCities",{url:"/cities",templateUrl:"modules/cities/views/list-cities.client.view.html"}).state("createCity",{url:"/cities/create",templateUrl:"modules/cities/views/create-city.client.view.html"}).state("viewHotCity",{url:"/cities/hot",templateUrl:"modules/cities/views/hot-cities.client.view.html"}).state("viewCity",{url:"/cities/:cityId",templateUrl:"modules/cities/views/view-city.client.view.html"})}]),angular.module("cities").controller("CitiesController",["$scope","$http","$stateParams","$location","Authentication","Cities","Countries",function($scope,$http,$stateParams,$location,Authentication,Cities,Countries){$scope.authentication=Authentication,$scope.itemsPerPage=10,$scope.currentPage=1,$scope.cityCount=0,$scope.keyword="",$scope.newCity={},$scope.newArea={},$scope.areas={},$scope.selectArea={},$scope.create=function(){var city=new Cities($scope.newCity);city.$save(function(response){$location.path("cities/"+response.city.id),$scope.name=""},function(errorResponse){$scope.error=errorResponse.data.message})},$scope.remove=function(city){if(city){city.$remove();for(var i in $scope.cities)$scope.cities[i]===city&&$scope.cities.splice(i,1)}else $scope.city.$remove(function(){$location.path("cities")})},$scope.update=function(){var city=$scope.city;for(var tipIndex in city.tips)city.tips[tipIndex]=city.tips[tipIndex].text;for(var thingsIndex in city.thingsMustDo)city.thingsMustDo[thingsIndex]=city.thingsMustDo[thingsIndex].text;$http.put("cities/"+city.id,city).success(function(data){0===data.statusCode&&(window.alert("城市信息更新成功! 😊"),location.reload())}).error(function(data){$scope.error=data.message})},$scope.removePicture=function(path){var pathIndex=$scope.city.album.indexOf(path);-1!==pathIndex&&($scope.city.album.splice(pathIndex,1),$http.put("cities/"+$scope.city.id,$scope.city).success(function(data){}))},$scope.addNewArea=function(){var isAreaNameUnique=!0;for(var index in $scope.areas)$scope.areas[index].name===$scope.newArea.name&&(isAreaNameUnique=!1);isAreaNameUnique?($scope.newArea.city=$scope.city.id,$http.post("/areas",{area:$scope.newArea}).success(function(data){0===data.statusCode?$scope.areas.push(data.area):window.alert(data.message)})):window.alert("城市下区域的名字不能相同")},$scope.deleteArea=function(area){$http["delete"]("/areas/"+area.id,{area:area}).success(function(data){if(0===data.statusCode){var index;for(index=0;index<$scope.areas.length;index++)$scope.areas[index].id===area.id&&($scope.areas.splice(index),index--)}else window.alert(data.message)})},$scope.editArea=function(area){var editAreaNameIsUnique=!0;for(var index in $scope.areas)$scope.areas[index].name===area.name&&$scope.areas[index].id!==area.id&&(editAreaNameIsUnique=!1);editAreaNameIsUnique?$http.put("/areas/"+area.id,{name:area.name}).success(function(data){0!==data.statusCode&&window.alert(data)}):(window.alert("修改之后的区域名，要唯一"),$scope.selectArea={},$http.get("/cities/"+$stateParams.cityId+"/areas").success(function(data){$scope.areas=data.areas}))},$scope.selectArea=function(area){$scope.selectArea=area},$scope.selectImg=function(imgPath){$scope.selectedImg="http://7xijtn.com1.z0.glb.clouddn.com/"+imgPath;var image=new Image;image.src=$scope.selectedImg,$scope.selectedImgWidth=image.width,$scope.selectedImageHeight=image.height},$scope.find=function(){Cities.get({pageSize:$scope.itemsPerPage,pageNumber:$scope.currentPage-1}).$promise.then(function(result){$scope.cities=result.cities,$scope.cityCount=result.total})},$scope.getCountries=function(){Countries.get().$promise.then(function(result){$scope.countries=result.countries})},$scope.getProvinces=function(){$http.get("countries/"+this.country+"/provinces").success(function(data){$scope.provinces=data.provinces})},$scope.setCoverUrl=function(coverPath){$scope.city.coverUrl=coverPath},$scope.getHotCities=function(){$http.get("cities/hot").success(function(data){$scope.hotCities=data.cities})},$scope.findByKeyword=function(){$http.get("cities/search",{params:{keyword:$scope.keyword}}).success(function(data){$scope.cities=data.cities,$scope.cityCount=data.total})},$scope.findOne=function(){Cities.get({cityId:$stateParams.cityId}).$promise.then(function(result){for(var tipIndex in result.city.tips)result.city.tips[tipIndex]={text:result.city.tips[tipIndex]};for(var thingsIndex in result.city.thingsMustDo)result.city.thingsMustDo[thingsIndex]={text:result.city.thingsMustDo[thingsIndex]};$scope.city=result.city})},$scope.getAreasByCityId=function(){$http.get("/cities/"+$stateParams.cityId+"/areas").success(function(data){$scope.areas=data.areas})},$scope.pageChanged=function(){Cities.get({pageSize:$scope.itemsPerPage,pageNumber:$scope.currentPage-1}).$promise.then(function(result){$scope.cities=result.cities,$scope.cityCount=result.total})},$scope.prevPage=function(){$scope.currentPage>0&&$scope.currentPage--},$scope.prevPageDisabled=function(){return 0===$scope.currentPage?"disabled":""},$scope.pageCount=function(){return Math.ceil($scope.pageCount/$scope.itemsPerPage)-1},$scope.nextPage=function(){$scope.currentPage<$scope.pageCount&&$scope.currentPage++},$scope.nextPageDisabled=function(){return $scope.currentPage===$scope.pageCount?"disabled":""},$scope.addTip=function(){$scope.city.tips.push({text:$scope.newTip}),$scope.newTip=""},$scope.deleteTip=function(index){$scope.city.tips.splice(index,1)},$scope.addThingsMustDo=function(){$scope.city.thingsMustDo.push({text:$scope.newThingsMustDo}),$scope.newThingsMustDo=""},$scope.deleteThingsMustDo=function(index){$scope.city.thingsMustDo.splice(index,1)},$scope.initUpdateUploadController=function(){var uploader=Qiniu.uploader({runtimes:"html5,flash,html4",browse_button:"pickfiles",container:"container",drop_element:"container",flash_swf_url:"lib/plupload/js/Moxie.swf",chunk_size:"4mb",uptoken_url:"/qiniu/city-image-upload-token",domain:"http://7xijtn.com1.z0.glb.clouddn.com/",save_key:!0,max_file_size:"1024kb",filters:[{title:"Image files",extensions:"jpg,jpeg,gif,png"}],x_vars:{id:$stateParams.cityId},auto_start:!0,init:{FilesAdded:function(up,files){$("table").show(),$("#success").hide(),plupload.each(files,function(file){var progress=new FileProgress(file,"fsUploadProgress");progress.setStatus("等待...")})},BeforeUpload:function(up,file){var progress=new FileProgress(file,"fsUploadProgress"),chunk_size=plupload.parseSize(this.getOption("chunk_size"));"html5"===up.runtime&&chunk_size&&progress.setChunkProgess(chunk_size)},UploadProgress:function(up,file){var progress=new FileProgress(file,"fsUploadProgress"),chunk_size=plupload.parseSize(this.getOption("chunk_size"));progress.setProgress(file.percent+"%",up.total.bytesPerSec,chunk_size)},UploadComplete:function(){$("#success").show()},FileUploaded:function(up,file,info){var infoObj=JSON.parse(info);$scope.city.album.push(infoObj.key),$scope.$apply();var progress=new FileProgress(file,"fsUploadProgress");progress.setComplete(up,info)},Error:function(up,err,errTip){$("table").show();var progress=new FileProgress(err.file,"fsUploadProgress");progress.setError(),progress.setStatus(errTip)}}});uploader.bind("FileUploaded",function(){})}}]),angular.module("cities").factory("Cities",["$resource",function($resource){return $resource("cities/:cityId",{cityId:"@_id"},{update:{method:"PUT"}})}]),angular.module("core").config(["$stateProvider","$urlRouterProvider",function($stateProvider,$urlRouterProvider){$urlRouterProvider.otherwise("/"),$stateProvider.state("home",{url:"/",templateUrl:"modules/users/views/authentication/signin.client.view.html"})}]),angular.module("core").controller("HeaderController",["$scope","Authentication","Menus",function($scope,Authentication,Menus){$scope.authentication=Authentication,$scope.isCollapsed=!1,$scope.menu=Menus.getMenu("topbar"),$scope.toggleCollapsibleMenu=function(){$scope.isCollapsed=!$scope.isCollapsed},$scope.$on("$stateChangeSuccess",function(){$scope.isCollapsed=!1})}]),angular.module("core").controller("HomeController",["$scope","Authentication",function($scope,Authentication){$scope.authentication=Authentication}]),angular.module("core").service("Menus",[function(){this.defaultRoles=["*"],this.menus={};var shouldRender=function(user){if(!user)return this.isPublic;if(~this.roles.indexOf("*"))return!0;for(var userRoleIndex in user.roles)for(var roleIndex in this.roles)if(this.roles[roleIndex]===user.roles[userRoleIndex])return!0;return!1};this.validateMenuExistance=function(menuId){if(menuId&&menuId.length){if(this.menus[menuId])return!0;throw new Error("Menu "+menuId+" does not exists")}throw new Error("MenuId was not provided")},this.getMenu=function(menuId){return this.validateMenuExistance(menuId),this.menus[menuId]},this.addMenu=function(menuId,isPublic,roles){return this.menus[menuId]={isPublic:isPublic||!1,roles:roles||this.defaultRoles,items:[],shouldRender:shouldRender},this.menus[menuId]},this.removeMenu=function(menuId){this.validateMenuExistance(menuId),delete this.menus[menuId]},this.addMenuItem=function(menuId,menuItemTitle,menuItemURL,menuItemType,menuItemUIRoute,isPublic,roles,position){return this.validateMenuExistance(menuId),this.menus[menuId].items.push({title:menuItemTitle,link:menuItemURL,menuItemType:menuItemType||"item",menuItemClass:menuItemType,uiRoute:menuItemUIRoute||"/"+menuItemURL,isPublic:null===isPublic||"undefined"==typeof isPublic?this.menus[menuId].isPublic:isPublic,roles:null===roles||"undefined"==typeof roles?this.menus[menuId].roles:roles,position:position||0,items:[],shouldRender:shouldRender}),this.menus[menuId]},this.addSubMenuItem=function(menuId,rootMenuItemURL,menuItemTitle,menuItemURL,menuItemUIRoute,isPublic,roles,position){this.validateMenuExistance(menuId);for(var itemIndex in this.menus[menuId].items)this.menus[menuId].items[itemIndex].link===rootMenuItemURL&&this.menus[menuId].items[itemIndex].items.push({title:menuItemTitle,link:menuItemURL,uiRoute:menuItemUIRoute||"/"+menuItemURL,isPublic:null===isPublic||"undefined"==typeof isPublic?this.menus[menuId].items[itemIndex].isPublic:isPublic,roles:null===roles||"undefined"==typeof roles?this.menus[menuId].items[itemIndex].roles:roles,position:position||0,shouldRender:shouldRender});return this.menus[menuId]},this.removeMenuItem=function(menuId,menuItemURL){this.validateMenuExistance(menuId);for(var itemIndex in this.menus[menuId].items)this.menus[menuId].items[itemIndex].link===menuItemURL&&this.menus[menuId].items.splice(itemIndex,1);return this.menus[menuId]},this.removeSubMenuItem=function(menuId,submenuItemURL){this.validateMenuExistance(menuId);for(var itemIndex in this.menus[menuId].items)for(var subitemIndex in this.menus[menuId].items[itemIndex].items)this.menus[menuId].items[itemIndex].items[subitemIndex].link===submenuItemURL&&this.menus[menuId].items[itemIndex].items.splice(subitemIndex,1);return this.menus[menuId]},this.addMenu("topbar")}]),angular.module("countries").run(["Menus",function(Menus){Menus.addMenuItem("topbar","国家","countries","dropdown","/countries(/create)?",!1,["unavaliable"],4),Menus.addSubMenuItem("topbar","countries","查看国家列表","countries"),Menus.addSubMenuItem("topbar","countries","添加国家","countries/create")}]),angular.module("countries").config(["$stateProvider",function($stateProvider){$stateProvider.state("listCountries",{url:"/countries",templateUrl:"modules/countries/views/list-countries.client.view.html"}).state("createCountry",{url:"/countries/create",templateUrl:"modules/countries/views/create-country.client.view.html"}).state("viewCountry",{url:"/countries/:countryId",templateUrl:"modules/countries/views/view-country.client.view.html"}).state("editCountry",{url:"/countries/:countryId/edit",templateUrl:"modules/countries/views/edit-country.client.view.html"})}]),angular.module("countries").controller("CountriesController",["$scope","$stateParams","$location","Authentication","Countries",function($scope,$stateParams,$location,Authentication,Countries){$scope.authentication=Authentication,$scope.create=function(){var country=new Countries({name:this.name});country.$save(function(response){$location.path("countries/"+response._id),$scope.name=""},function(errorResponse){$scope.error=errorResponse.data.message})},$scope.remove=function(country){if(country){country.$remove();for(var i in $scope.countries)$scope.countries[i]===country&&$scope.countries.splice(i,1)}else $scope.country.$remove(function(){$location.path("countries")})},$scope.update=function(){var country=$scope.country;country.$update(function(){$location.path("countries/"+country._id)},function(errorResponse){$scope.error=errorResponse.data.message})},$scope.find=function(){$scope.countries=Countries.query()},$scope.findOne=function(){$scope.country=Countries.get({countryId:$stateParams.countryId})}}]),angular.module("countries").factory("Countries",["$resource",function($resource){return $resource("countries/:countryId",{countryId:"@_id"},{update:{method:"PUT"}})}]),angular.module("objection-reports").run(["Menus",function(Menus){Menus.addMenuItem("topbar","用户举报","objection-reports","dropdown","/objection-reports(/create)?",!1,["unavaliable"],11),Menus.addSubMenuItem("topbar","objection-reports","举报列表","objection-reports")}]),angular.module("objection-reports").config(["$stateProvider",function($stateProvider){$stateProvider.state("listObjectionReports",{url:"/objection-reports",templateUrl:"modules/objection-reports/views/list-objection-reports.client.view.html"}).state("createObjectionReport",{url:"/objection-reports/create",templateUrl:"modules/objection-reports/views/create-objection-report.client.view.html"}).state("viewObjectionReport",{url:"/objection-reports/:objectionReportId",templateUrl:"modules/objection-reports/views/view-objection-report.client.view.html"}).state("editObjectionReport",{url:"/objection-reports/:objectionReportId/edit",templateUrl:"modules/objection-reports/views/edit-objection-report.client.view.html"})}]),angular.module("objection-reports").controller("ObjectionReportsController",["$scope","$stateParams","$location","$http","Authentication","ObjectionReports",function($scope,$stateParams,$location,$http,Authentication,ObjectionReports){$scope.authentication=Authentication,$scope.itemsPerPage=10,$scope.create=function(){var objectionReport=new ObjectionReports({name:this.name});objectionReport.$save(function(response){$location.path("objection-reports/"+response._id),$scope.name=""},function(errorResponse){$scope.error=errorResponse.data.message})},$scope.remove=function(objectionReport){if(objectionReport){objectionReport.$remove();for(var i in $scope.objectionReports)$scope.objectionReports[i]===objectionReport&&$scope.objectionReports.splice(i,1)}else $scope.objectionReport.$remove(function(){$location.path("objection-reports")})},$scope.update=function(){var objectionReport=$scope.objectionReport;objectionReport.$update(function(){$location.path("objection-reports/"+objectionReport._id)},function(errorResponse){$scope.error=errorResponse.data.message})},$scope.find=function(){ObjectionReports.get({pageNumber:0,pageSize:$scope.itemsPerPage}).$promise.then(function(result){$scope.objectionReports=result.objectionReports,$scope.totalItems=result.total})},$scope.findOne=function(){$scope.objectionReport=ObjectionReports.get({objectionReportId:$stateParams.objectionReportId})}}]),angular.module("objection-reports").factory("ObjectionReports",["$resource",function($resource){return $resource("objection-reports/:objectionReportId",{objectionReportId:"@_id"},{update:{method:"PUT"}})}]),angular.module("provinces").run(["Menus",function(Menus){Menus.addMenuItem("topbar","省份","provinces","dropdown","/provinces(/create)?",!1,["unavaliable"],5),Menus.addSubMenuItem("topbar","provinces","查看所有省份","provinces"),Menus.addSubMenuItem("topbar","provinces","添加省份","provinces/create")}]),angular.module("provinces").config(["$stateProvider",function($stateProvider){$stateProvider.state("listProvinces",{url:"/provinces",templateUrl:"modules/provinces/views/list-provinces.client.view.html"}).state("createProvince",{url:"/provinces/create",templateUrl:"modules/provinces/views/create-province.client.view.html"}).state("viewProvince",{url:"/provinces/:provinceId",templateUrl:"modules/provinces/views/view-province.client.view.html"}).state("editProvince",{url:"/provinces/:provinceId/edit",templateUrl:"modules/provinces/views/edit-province.client.view.html"})}]),angular.module("provinces").controller("ProvincesController",["$scope","$stateParams","$location","Authentication","Provinces",function($scope,$stateParams,$location,Authentication,Provinces){$scope.authentication=Authentication,$scope.create=function(){var province=new Provinces({name:this.name});province.$save(function(response){$location.path("provinces/"+response._id),$scope.name=""},function(errorResponse){$scope.error=errorResponse.data.message})},$scope.remove=function(province){if(province){province.$remove();for(var i in $scope.provinces)$scope.provinces[i]===province&&$scope.provinces.splice(i,1)}else $scope.province.$remove(function(){$location.path("provinces")})},$scope.update=function(){var province=$scope.province;province.$update(function(){$location.path("provinces/"+province._id)},function(errorResponse){$scope.error=errorResponse.data.message})},$scope.find=function(){$scope.provinces=Provinces.query()},$scope.findOne=function(){$scope.province=Provinces.get({provinceId:$stateParams.provinceId})}}]),angular.module("provinces").factory("Provinces",["$resource",function($resource){return $resource("provinces/:provinceId",{provinceId:"@_id"},{update:{method:"PUT"}})}]),angular.module("quota-recorders").run(["Menus",function(Menus){Menus.addMenuItem("topbar","配额请求","quota-recorders","dropdown","/quota-recorders(/check)?",!1,["admin"],15),Menus.addSubMenuItem("topbar","quota-recorders","查看所有请求","quota-recorders"),Menus.addSubMenuItem("topbar","quota-recorders","审核请求","unchecked-quota-recorders")}]),angular.module("quota-recorders").config(["$stateProvider",function($stateProvider){$stateProvider.state("listQuotaRecorder",{url:"/quota-recorders",templateUrl:"modules/quota-recorder/views/list-quota-recorder.client.view.html"}).state("checkQuotaRecorder",{url:"/unchecked-quota-recorders",templateUrl:"modules/quota-recorder/views/check-quota-recorder.client.view.html"}).state("viewQuotaRecorder",{url:"/quota-recorders/:quotaRecorderId",templateUrl:"modules/quota-recorder/views/view-quota-recorder.client.view.html"})}]),angular.module("quota-recorders").controller("CheckQuotaRecordersController",["$scope","$stateParams","$location","$http","Authentication","QuotaRecorders",function($scope,$stateParams,$location,$http,Authentication,QuotaRecorders){$scope.authentication=Authentication,$scope.itemsPerPage=10,$scope.totalUncheckedItems=0,$scope.uncheckedCurrentPage=0,$scope.uncheckedQuotaRecorders=[],$scope.totalCheckedItems=0,$scope.checkedCurrentPage=0,$scope.checkedQuotaRecorders=[],$scope.totalDeniedItems=0,$scope.deniedCurrentPage=0,$scope.deniedQuotaRecorders=[],$scope.getUncheckedList=function(){$http.get("quota-recorders",{params:{result:"unchecked"}}).success(function(data){$scope.uncheckedQuotaRecorders=data.quotaRecorders,$scope.totalUncheckedItems=data.total}).error(function(data){$scope.error=data.message})},$scope.uncheckedPageChanged=function(){$http.get("quota-recorders",{params:{result:"unchecked",pageSize:$scope.itemsPerPage,pageNumber:$scope.uncheckedCurrentPage-1}}).success(function(data){$scope.uncheckedQuotaRecorders=data.quotaRecorders,$scope.totalUncheckedItems=data.total}).error(function(data){$scope.error=data.message})},$scope.getCheckedList=function(){$http.get("quota-recorders",{params:{result:"pass"}}).success(function(data){$scope.checkedQuotaRecorders=data.quotaRecorders,$scope.totalCheckedItems=data.total}).error(function(data){$scope.error=data.message})},$scope.checkedPageChanged=function(){$http.get("quota-recorders",{params:{result:"pass",pageSize:$scope.itemsPerPage,pageNumber:$scope.checkedCurrentPage-1}}).success(function(data){$scope.checkedQuotaRecorders=data.quotaRecorders,$scope.totalCheckedItems=data.total}).error(function(data){$scope.error=data.message})},$scope.getDeniedList=function(){$http.get("quota-recorders",{params:{result:"deny"}}).success(function(data){$scope.deniedQuotaRecorders=data.quotaRecorders,$scope.totalDeniedItems=data.total}).error(function(data){$scope.error=data.message})},$scope.deniedPageChanged=function(){$http.get("quota-recorders",{params:{result:"deny",pageSize:$scope.itemsPerPage,pageNumber:$scope.deniedCurrentPage-1}}).success(function(data){$scope.deniedQuotaRecorders=data.quotaRecorders,$scope.totalDeniedItems=data.total}).error(function(data){$scope.error=data.message})}}]),angular.module("quota-recorders").controller("QuotaRecordersController",["$scope","$stateParams","$location","$http","Authentication","QuotaRecorders",function($scope,$stateParams,$location,$http,Authentication,QuotaRecorders){$scope.authentication=Authentication,$scope.itemsPerPage=10,$scope.currentPage=0,$scope.find=function(){$http.get("quota-recorders").success(function(data){$scope.quotaRecorders=data.quotaRecorders,$scope.totalItems=data.total}).error(function(data){$scope.error=data.message})},$scope.pageChanged=function(){$http.get("quota-recorders",{params:{pageSize:$scope.itemsPerPage,pageNumber:$scope.currentPage-1}}).success(function(data){$scope.quotaRecorders=data.quotaRecorders,$scope.totalItems=data.total}).error(function(data){$scope.error=data.message})},$scope.findOne=function(){QuotaRecorders.get({quotaRecorderId:$stateParams.quotaRecorderId}).$promise.then(function(result){$scope.quotaRecorder=result})},$scope.checkQuotaRecorder=function(result){"deny"!==result||$scope.quotaRecorder.message?$http.post("/quota-recorders/"+$stateParams.quotaRecorderId+"/handle-request",{result:result,message:$scope.quotaRecorder.message}).success(function(data){0===data.statusCode?(window.alert("成功! 😊"),location.reload()):$scope.error=result.message}).error(function(data){$scope.error=data.message}):window.alert("请填写拒绝的理由")}}]),angular.module("quota-recorders").factory("QuotaRecorders",["$resource",function($resource){
return $resource("quota-recorders/:quotaRecorderId",{quotaRecorderId:"@id"},{update:{method:"PUT"}})}]),angular.module("scenic-areas").run(["Menus",function(Menus){Menus.addMenuItem("topbar","景区","scenic-areas","dropdown","/scenic-areas(/create)?",!1,["unavaliable"],7),Menus.addSubMenuItem("topbar","scenic-areas","查看景区列表","scenic-areas"),Menus.addSubMenuItem("topbar","scenic-areas","创建景区","scenic-areas/create")}]),angular.module("scenic-areas").config(["$stateProvider",function($stateProvider){$stateProvider.state("listScenicAreas",{url:"/scenic-areas",templateUrl:"modules/scenic-areas/views/list-scenic-areas.client.view.html"}).state("createScenicArea",{url:"/scenic-areas/create",templateUrl:"modules/scenic-areas/views/create-scenic-area.client.view.html"}).state("viewScenicArea",{url:"/scenic-areas/:scenicAreaId",templateUrl:"modules/scenic-areas/views/view-scenic-area.client.view.html"})}]),angular.module("scenic-areas").controller("ScenicAreasController",["$scope","$stateParams","$location","$http","Authentication","ScenicAreas",function($scope,$stateParams,$location,$http,Authentication,ScenicAreas){$scope.authentication=Authentication,$scope.cityToAdd={},$scope.cityToUpdate={},$scope.citiesInArea=[],$scope.getProvinces=function(){$http.get("countries/551115cea6ab3f760913b2e5/provinces").success(function(data){$scope.provinces=data.provinces})},$scope.getCities=function(provinceId){$http.get("provinces/"+provinceId+"/cities").success(function(data){$scope.cities=data.cities})},$scope.create=function(){var cityArray=[];for(var index in $scope.citiesInArea)cityArray.push($scope.citiesInArea[index].id);var scenicArea=new ScenicAreas({name:this.name,introduction:this.introduction,hotRating:this.hotRating,cities:cityArray});scenicArea.$save(function(response){$location.path("scenic-areas/"+response._id),$scope.name=""},function(errorResponse){$scope.error=errorResponse.data.message})},$scope.remove=function(){$scope.scenicAreaToDelete&&$http["delete"]("scenic-areas/"+$scope.scenicAreaToDelete._id).then(function(data){for(var i in $scope.scenicAreas)$scope.scenicAreas[i]===$scope.scenicAreaToDelete&&($scope.scenicAreas.splice(i,1),window.alert("景区"+$scope.scenicAreaToDelete.name+"删除成功！"),$scope.scenicAreaToDelete=void 0)})},$scope.update=function(){var scenicArea=JSON.parse(JSON.stringify($scope.scenicArea)),cityArray=[];for(var index in scenicArea.cities)cityArray.push(scenicArea.cities[index].id);scenicArea.cities=cityArray,$http.put("scenic-areas/"+scenicArea._id,scenicArea).success(function(data){window.alert("更新成功! 😊")}).error(function(data){$scope.error=data.message})},$scope.find=function(){$http.get("scenic-areas").success(function(data){$scope.scenicAreas=data.scenicAreas}).error(function(err){$scope.error=err.message})},$scope.findOne=function(){$http.get("scenic-areas/"+$stateParams.scenicAreaId).success(function(data){$scope.scenicArea=data.scenicArea}).error(function(err){$scope.error=err.message})},$scope.addCity=function(updateFlag){"create"===updateFlag&&$scope.cityToAdd.selectedCity&&-1===$scope.citiesInArea.indexOf($scope.cityToAdd.selectedCity)?$scope.citiesInArea.push($scope.cityToAdd.selectedCity):"update"===updateFlag&&$scope.cityToUpdate.selectedCity&&-1===$scope.scenicArea.cities.indexOf($scope.cityToUpdate.selectedCity)&&$scope.scenicArea.cities.push($scope.cityToUpdate.selectedCity)},$scope.removeCity=function(updateFlag,cityId){var index;if("update"===updateFlag)for(index in $scope.scenicArea.cities)$scope.scenicArea.cities[index].id===cityId&&$scope.scenicArea.cities.splice(index,1);else if("create"===updateFlag)for(index in $scope.citiesInArea)$scope.citiesInArea[index].id===cityId&&$scope.citiesInArea.splice(index,1)},$scope.setScenicAreaToDelete=function(scenicArea){$scope.scenicAreaToDelete=scenicArea}}]),angular.module("scenic-areas").factory("ScenicAreas",["$resource",function($resource){return $resource("scenic-areas/:scenicAreaId",{scenicAreaId:"@_id"},{update:{method:"PUT"}})}]),angular.module("scenic-spots").run(["Menus",function(Menus){Menus.addMenuItem("topbar","执行地","scenic-spots","dropdown","/scenic-spots(/create)?",!1,["editor","admin"],8),Menus.addSubMenuItem("topbar","scenic-spots","创建执行地","scenic-spots/create"),Menus.addSubMenuItem("topbar","scenic-spots","查看所有执行地","scenic-spots")}]),angular.module("scenic-spots").config(["$stateProvider",function($stateProvider){$stateProvider.state("listScenicSpots",{url:"/scenic-spots",templateUrl:"modules/scenic-spots/views/list-scenic-spots.client.view.html"}).state("createScenicSpot",{url:"/scenic-spots/create",templateUrl:"modules/scenic-spots/views/create-scenic-spot.client.view.html"}).state("queryScenicSpot",{url:"/scenic-spots/query",templateUrl:"modules/scenic-spots/views/query-scenic-spot.client.view.html"}).state("checkScenicSpot",{url:"/scenic-spots/check",templateUrl:"modules/scenic-spots/views/check-scenic-spot.client.view.html"}).state("viewScenicSpot",{url:"/scenic-spots/:scenicSpotId",templateUrl:"modules/scenic-spots/views/view-scenic-spot.client.view.html"})}]),angular.module("scenic-spots").controller("ScenicSpotsController",["$scope","$stateParams","$location","$http","Authentication","ScenicSpots","Countries","Pictures","Provinces","Cities",function($scope,$stateParams,$location,$http,Authentication,ScenicSpots,Countries,Pictures){$scope.authentication=Authentication,$scope.scenicSpotType=[{type:"执行地",value:"custom"},{type:"",value:"manual"}],$scope.currentPage=1,$scope.itemsPerPage=10,$scope.newScenicSpot=new ScenicSpots,$scope.newScenicSpot.album=[],$scope.newScenicSpot.tips=[],$scope.authenticatedTenantType=[{type:"是",bool:!0},{type:"否",bool:!1}],$scope.isOnMainPageType=[{type:"是",bool:!0},{type:"否",bool:!1}],$scope.query={},$scope.keyword="",$scope.findScenicSpotsByKeywordFlag="false",$scope.findScenicSpotsByCityFlag="false",$scope.create=function(){!$scope.newScenicSpot.location||!$scope.newScenicSpot.location.lat||!$scope.newScenicSpot.location.lng||$scope.newScenicSpot.location.lat>=90||$scope.newScenicSpot.location.lat<=-90||$scope.newScenicSpot.location.lng<=0||$scope.newScenicSpot.location.lng>=180?window.alert("请正确输入经纬度的信息。经度（－180~180） 纬度（-90~90）！"):$scope.newScenicSpot.name?$scope.newScenicSpot.$save(function(response){window.alert("执行地「"+response.scenicSpot.name+"」创建成功！"),$scope.newScenicSpot=new ScenicSpots,$scope.newScenicSpot.album=[],$scope.newScenicSpot.tips=[],$location.path("/scenic-spots")},function(errorResponse){$scope.error=errorResponse.data.message}):window.alert("缺少执行地名称！")},$scope.remove=function(scenicSpot){if($("#myPleaseWait").modal("show"),scenicSpot){scenicSpot.$remove();for(var i in $scope.scenicSpots)$scope.scenicSpots[i]===scenicSpot&&$scope.scenicSpots.splice(i,1)}else $http["delete"]("scenic-spots/"+$scope.scenicSpot.id).success(function(){$("#myPleaseWait").modal("hide"),window.alert("执行地"+$scope.scenicSpot.name+"删除成功！"),$location.path("scenic-spots")})},$scope.getCountries=function(){Countries.get().$promise.then(function(result){$scope.countries=result.countries})},$scope.searchByGetProvinces=function(){$http.get("countries/551115cea6ab3f760913b2e5/provinces").success(function(data){$scope.provinces=data.provinces})},$scope.searchByGetCities=function(){$http.get("provinces/"+$scope.query.province+"/cities").success(function(data){$scope.cities=data.cities})},$scope.findByCities=function(){$scope.findScenicSpotsByKeywordFlag="false",$scope.findScenicSpotsByCityFlag="true",$http.get("cities/"+$scope.query.city+"/scenic-spots",{params:{pageSize:$scope.itemsPerPage,pageNumber:0}}).success(function(data){$scope.scenicSpots=data.scenicSpots,$scope.totalItems=data.total})},$scope.findByKeywords=function(){$scope.findScenicSpotsByKeywordFlag="true",$scope.findScenicSpotsByCityFlag="false",$http.get("scenic-spots/search?keyword="+$scope.keyword,{params:{pageSize:$scope.itemsPerPage,pageNumber:0}}).success(function(data){$scope.scenicSpots=data.scenicSpots,$scope.totalItems=data.total}).error(function(data){$scope.error=data.message})},$scope.getProvinces=function(){$http.get("countries/"+this.newScenicSpot.country+"/provinces").success(function(data){$scope.provinces=data.provinces})},$scope.getCities=function(){$http.get("provinces/"+this.newScenicSpot.province+"/cities").success(function(data){$scope.cities=data.cities})},$scope.update=function(){var scenicSpot=JSON.parse(JSON.stringify($scope.scenicSpot));for(var index in scenicSpot.tips)scenicSpot.tips[index]=scenicSpot.tips[index].text;for(index in scenicSpot.pictures)scenicSpot.pictures[index]=scenicSpot.pictures[index].id;scenicSpot.geoLocation=[scenicSpot.location.lng,scenicSpot.location.lat],$http.put("scenic-spots/"+scenicSpot.id,scenicSpot).success(function(data){0===data.statusCode&&window.alert("更新成功! 😊")}).error(function(data){$scope.error=data.message})},$scope.setCoverUrl=function(coverUrl,scenicSpot){scenicSpot.coverUrl=coverUrl},$scope.setOnMainPage=function(pictureId,isOnMainPage){Pictures.update({id:pictureId,isOnMainPage:isOnMainPage}).$promise.then(function(result){0===result.statusCode?(window.alert("设置成功! "),location.reload()):$scope.error=result.message})},$scope.find=function(){ScenicSpots.get({pageNumber:0,pageSize:$scope.itemsPerPage}).$promise.then(function(result){$scope.scenicSpots=result.scenicSpots,$scope.totalItems=result.total})},$scope.findOne=function(){ScenicSpots.get({scenicSpotId:$stateParams.scenicSpotId}).$promise.then(function(result){for(var tipIndex in result.scenicSpot.tips)result.scenicSpot.tips[tipIndex]={text:result.scenicSpot.tips[tipIndex]};$scope.scenicSpot=result.scenicSpot})},$scope.getEditPage=function(scenicSpot){window.open("/#!/scenic-spots/"+scenicSpot.id,"_blank")},$scope.pageChanged=function(){"true"===$scope.findScenicSpotsByKeywordFlag&&"false"===$scope.findScenicSpotsByCityFlag?$http.get("scenic-spots/search?keyword="+$scope.keyword,{params:{pageSize:$scope.itemsPerPage,pageNumber:$scope.currentPage-1}}).success(function(data){$scope.scenicSpots=data.scenicSpots}).error(function(data){$scope.error=data.message}):"true"===$scope.findScenicSpotsByCityFlag&&"false"===$scope.findScenicSpotsByKeywordFlag?$http.get("cities/"+$scope.query.city+"/scenic-spots",{params:{pageSize:$scope.itemsPerPage,pageNumber:$scope.currentPage-1}}).success(function(data){$scope.scenicSpots=data.scenicSpots}):ScenicSpots.get({pageNumber:$scope.currentPage-1,pageSize:$scope.itemsPerPage}).$promise.then(function(result){$scope.scenicSpots=result.scenicSpots})},$scope.removePicture=function(picId){$http["delete"]("pictures/"+picId).success(function(data){for(var index=0;index<$scope.scenicSpot.pictures.length;index++)if($scope.scenicSpot.pictures[index].id===picId){$scope.scenicSpot.pictures.splice(index,1);break}})},$scope.addTip=function(update){"update"===update?$scope.scenicSpot.tips.push({text:$scope.newTip}):$scope.newScenicSpot.tips.push($scope.newTip),$scope.newTip=""},$scope.deleteTip=function(index,update){"update"===update?$scope.scenicSpot.tips.splice(index,1):$scope.newScenicSpot.tips.splice(index,1)},$scope.selectImg=function(imgPath){$scope.selectedImg="http://7xijtn.com1.z0.glb.clouddn.com/"+imgPath;var image=new Image;image.src=$scope.selectedImg,$scope.selectedImgWidth=image.width,$scope.selectedImageHeight=image.height},$scope.checkScenicSpot=function(result){$http.post("/scenic-spots/"+$scope.scenicSpot.id+"/checked-scenicSpot",{checkedResult:result}).success(function(){$location.path("scenic-spots/check")}).error(function(data){window.alert(data.message)})},$scope.initUpdateUploadController=function(){var uploader=Qiniu.uploader({runtimes:"html5,flash,html4",browse_button:"pickfiles",container:"container",drop_element:"container",flash_swf_url:"lib/plupload/js/Moxie.swf",chunk_size:"4mb",uptoken_url:"/qiniu/scenicspot-image-upload-token",domain:"http://7xijtn.com1.z0.glb.clouddn.com/",save_key:!0,max_file_size:"10mb",filters:[{title:"Image files",extensions:"jpg,jpeg,gif,png"}],x_vars:{id:$stateParams.scenicSpotId},auto_start:!0,init:{FilesAdded:function(up,files){$("table").show(),$("#success").hide(),plupload.each(files,function(file){var progress=new FileProgress(file,"fsUploadProgress");progress.setStatus("等待...")})},BeforeUpload:function(up,file){var progress=new FileProgress(file,"fsUploadProgress"),chunk_size=plupload.parseSize(this.getOption("chunk_size"));"html5"===up.runtime&&chunk_size&&progress.setChunkProgess(chunk_size)},UploadProgress:function(up,file){var progress=new FileProgress(file,"fsUploadProgress"),chunk_size=plupload.parseSize(this.getOption("chunk_size"));progress.setProgress(file.percent+"%",up.total.bytesPerSec,chunk_size)},UploadComplete:function(){$("#success").show()},FileUploaded:function(up,file,info){var infoObj=JSON.parse(info);if(infoObj.savedPicture){var picPattern={id:infoObj.savedPicture.id,coverUrl:infoObj.savedPicture.coverUrl};$scope.scenicSpot.pictures.push(picPattern)}else 12001===infoObj.statusCode&&window.alert(infoObj.message);$scope.$apply();var progress=new FileProgress(file,"fsUploadProgress");progress.setComplete(up,info)},Error:function(up,err,errTip){$("table").show();var progress=new FileProgress(err.file,"fsUploadProgress");progress.setError(),progress.setStatus(errTip)}}});uploader.bind("FileUploaded",function(){})}}]),angular.module("scenic-spots").factory("ScenicSpots",["$resource",function($resource){return $resource("scenic-spots/:scenicSpotId",{scenicSpotId:"@id"},{update:{method:"PUT"}})}]),angular.module("scenic-spots").factory("Pictures",["$resource",function($resource){return $resource("pictures/:pictureId/on-main-page",{pictureId:"@id"},{update:{method:"PUT"},setOnMainPage:{}})}]),angular.module("task-lists").run(["Menus",function(Menus){Menus.addMenuItem("topbar","玩鲜线路","task-lists","dropdown","/task-lists(/create)?",!1,["admin"],3),Menus.addSubMenuItem("topbar","task-lists","创建玩鲜线路","task-lists/create",null,!1,["admin"]),Menus.addSubMenuItem("topbar","task-lists","玩鲜线路列表","task-lists",null,!1,["admin"])}]),angular.module("task-lists").config(["$stateProvider",function($stateProvider){$stateProvider.state("listTaskLists",{url:"/task-lists",templateUrl:"modules/task-lists/views/list-task-lists.client.view.html"}).state("createTaskList",{url:"/task-lists/create",templateUrl:"modules/task-lists/views/create-task-list.client.view.html"}).state("editTaskList",{url:"/task-lists/:taskListId/edit",templateUrl:"modules/task-lists/views/edit-task-list.client.view.html"})}]),angular.module("task-lists").controller("TaskListsController",["$scope","$stateParams","$location","$http","Authentication","TaskLists","Tasks","Countries","Provinces","Cities",function($scope,$stateParams,$location,$http,Authentication,TaskLists,Tasks,Countries){$scope.authentication=Authentication,$scope.query={},$scope.newTask={tasks:[]},$scope.currentPage=1,$scope.itemsPerPage=10,$scope.taskCount=0,$scope.isOnMainPageType=[{type:"是",bool:!0},{type:"否",bool:!1}],$scope.cityChangeFlag="",$scope.beforeCreate=function(){$scope.newTaskList={}},$scope.create=function(){if($scope.newTaskList.name)if($scope.newTaskList.province&&$scope.newTaskList.city&&$scope.newTaskList.area){var taskList=$scope.newTaskList,taskIdList=[];for(var taskIndex in taskList.tasks)taskIdList.push(taskList.tasks[taskIndex].id);taskList.tasks=taskIdList,TaskLists.save(taskList).$promise.then(function(result){0===result.statusCode?(window.alert("创建成功！"),$location.path("task-lists/"+result.taskListId+"/edit")):$scope.error=result.message})}else window.alert("无城市信息（哎呀..不是我批评你，你说你咋能忘了输入城市信息呢？天天想什么呢，不认真工作！！）");else window.alert("缺少名称！~~")},$scope.getCountries=function(){Countries.get().$promise.then(function(result){$scope.countries=result.countries})},$scope.getProvinces=function(){this.newTaskList?$http.get("countries/"+this.newTaskList.country+"/provinces").success(function(data){$scope.provinces=data.provinces}):$http.get("countries/"+this.taskList.country+"/provinces").success(function(data){$scope.provinces=data.provinces})},$scope.getCities=function(){$scope.newTaskList?$http.get("provinces/"+this.newTaskList.province+"/cities").success(function(data){$scope.cities=data.cities}):$http.get("provinces/"+this.taskList.province+"/cities").success(function(data){$scope.cities=data.cities})},$scope.getAreas=function(){$scope.newTaskList?$http.get("/cities/"+this.newTaskList.city+"/areas").success(function(data){console.dir(data),$scope.areas=data.areas}):$http.get("/cities/"+this.taskList.city.id+"/areas").success(function(data){$scope.areas=data.areas})},$scope.getTasksInCity=function(){Tasks.get({pageSize:$scope.itemsPerPage,city:$scope.newTaskList.city}).$promise.then(function(result){$scope.tasks=result.tasks,$scope.taskCount=result.total})},$scope.saveProvinceAndCityAndArea=function(newCity,newProvince,newArea){newCity===$scope.taskList.city&&($scope.cityChangeFlag='别忘记点击"更新"哦~~！'),$scope.taskList&&($scope.taskList.city=newCity,$scope.taskList.province=newProvince,$scope.taskList.area=newArea,$http.get("/tasks?city="+$scope.taskList.city.id).success(function(data){$scope.tasks=data.tasks})),$scope.newTaskList&&($scope.newTaskList.city=newCity,$scope.newTaskList.province=newProvince,$scope.newTaskList.area=newArea)},$scope.remove=function(taskList){if(taskList){taskList.$remove();for(var i in $scope.taskLists)$scope.taskLists[i]===taskList&&$scope.taskLists.splice(i,1)}else $scope.taskList.$remove(function(){$location.path("task-lists")})},$scope.update=function(){if($scope.taskList.name)if($scope.taskList.city){var taskList=$scope.taskList;taskList.city&&taskList.city.id&&(taskList.city=taskList.city.id),taskList.area&&taskList.area.id&&(taskList.area=taskList.area.id),taskList.rule||(taskList.rule="");var taskIdList=[];for(var taskIndex in taskList.tasks)taskIdList.push(taskList.tasks[taskIndex].id);taskList.tasks=taskIdList,TaskLists.update(taskList).$promise.then(function(result){0===result.statusCode?(window.alert("更新成功！"),location.reload()):$scope.error=result.message})}else window.alert("请更新城市信息 😊");else window.alert("缺少名称~~")},$scope.find=function(){TaskLists.get({pageSize:$scope.itemsPerPage}).$promise.then(function(result){$scope.taskLists=result.taskLists,$scope.totalItems=result.total})},$scope.findOne=function(){TaskLists.get({taskListId:$stateParams.taskListId}).$promise.then(function(result){$scope.taskList=result.taskList,$scope.taskList&&$scope.taskList.city&&$http.get("/tasks?city="+$scope.taskList.city.id).success(function(data){$scope.tasks=data.tasks,$scope.taskCount=data.total})})},$scope.addTask=function(taskList,task){taskList.tasks||(taskList.tasks=[]),-1===JSON.stringify(taskList.tasks).indexOf(task.id)?taskList.tasks.push(task):window.alert(task.name+"已经被加入了任务列表中，请勿重复添加！")},$scope.removeTask=function(taskList,task){var taskIndex=taskList.tasks.indexOf(task);-1!==taskIndex&&taskList.tasks.splice(taskIndex,1)},$scope.remove=function(){$http["delete"]("task-lists/"+$scope.taskList.id).success(function(){$location.path("/task-lists")})},$scope.pageChanged=function(){TaskLists.get({pageNumber:$scope.currentPage-1,pageSize:$scope.itemsPerPage}).$promise.then(function(result){$scope.taskLists=result.taskLists})},$scope.taskPageChanged=function(){var query;query=$scope.newTaskList&&$scope.newTaskList.city?$scope.newTaskList.city:$scope.taskList.city.id,Tasks.get({pageNumber:$scope.currentPage-1,pageSize:$scope.itemsPerPage,city:query}).$promise.then(function(result){$scope.tasks=result.tasks})},$scope.initUpdateUploadController=function(){var uploader=Qiniu.uploader({runtimes:"html5,flash,html4",browse_button:"pickfiles",container:"container",drop_element:"container",flash_swf_url:"lib/plupload/js/Moxie.swf",chunk_size:"4mb",uptoken_url:"/qiniu/task-list-cover-upload-token",domain:"http://7xijtn.com1.z0.glb.clouddn.com/",save_key:!0,max_file_size:"10mb",filters:[{title:"Image files",extensions:"jpg,jpeg,gif,png"}],x_vars:{taskListId:$stateParams.taskListId},auto_start:!0,init:{FilesAdded:function(up,files){$("table").show(),$("#success").hide(),plupload.each(files,function(file){var progress=new FileProgress(file,"fsUploadProgress");progress.setStatus("等待...")})},BeforeUpload:function(up,file){var progress=new FileProgress(file,"fsUploadProgress"),chunk_size=plupload.parseSize(this.getOption("chunk_size"));"html5"===up.runtime&&chunk_size&&progress.setChunkProgess(chunk_size)},UploadProgress:function(up,file){var progress=new FileProgress(file,"fsUploadProgress"),chunk_size=plupload.parseSize(this.getOption("chunk_size"));progress.setProgress(file.percent+"%",up.total.bytesPerSec,chunk_size)},UploadComplete:function(){$("#success").show()},FileUploaded:function(up,file,info){var infoObj=JSON.parse(info);$scope.taskList.coverUrl=infoObj.path,$scope.$apply();var progress=new FileProgress(file,"fsUploadProgress");progress.setComplete(up,info)},Error:function(up,err,errTip){$("table").show();var progress=new FileProgress(err.file,"fsUploadProgress");progress.setError(),progress.setStatus(errTip)}}});uploader.bind("FileUploaded",function(){})}}]),angular.module("task-lists").factory("TaskLists",["$resource",function($resource){return $resource("task-lists/:taskListId",{taskListId:"@id"},{update:{method:"PUT"}})}]),angular.module("tasks").run(["Menus",function(Menus){Menus.addMenuItem("topbar","任务","tasks","dropdown","/tasks(/create)?",!1,["admin"],2),Menus.addSubMenuItem("topbar","tasks","创建新任务","tasks/create",null,!1,["admin"]),Menus.addSubMenuItem("topbar","tasks","所有任务","tasks",null,!1,["admin"])}]),angular.module("tasks").config(["$stateProvider",function($stateProvider){$stateProvider.state("listTasks",{url:"/tasks",templateUrl:"modules/tasks/views/list-tasks.client.view.html"}).state("createTask",{url:"/tasks/create",templateUrl:"modules/tasks/views/create-task.client.view.html"}).state("editTask",{url:"/tasks/:taskId/edit",templateUrl:"modules/tasks/views/edit-task.client.view.html"})}]),angular.module("tasks").controller("TasksController",["$scope","$stateParams","$location","$http","Authentication","Tasks","TasksQuota","ScenicSpots","Users","Countries","Provinces","Cities",function($scope,$stateParams,$location,$http,Authentication,Tasks,TaskQuota,ScenicSpots,Users,Countries){$scope.authentication=Authentication,$scope.bonusQuotas=[50,100,200],$scope.cityChangeFlag="",$scope.currentPage=1,$scope.itemsPerPage=10,$scope.keyword=null,$scope.tenantKeyword="",$scope.scenicSpotKeyword="",$scope.tenants=null,$scope.scenicSpots=null,$scope.choosedScenicSpotName=null,$scope.choosedTenantName=null,$scope.allActivityTaskStatus=[{value:!1,info:"否"},{value:!0,info:"是"}],$scope.beforeCreate=function(){$scope.newTask=new Tasks,$scope.newTask.isActivity=$scope.allActivityTaskStatus[0].value,$scope.newTask.selectedByEditor=$scope.allActivityTaskStatus[0].value},$scope.create=function(){$scope.newTask.name&&$scope.newTask.city&&$scope.newTask.bonus&&$scope.newTask.belongToScenicSpot&&$scope.newTask.belongToUser?$scope.newTask.$save(function(response){0===response.statusCode?($location.path("tasks/"+response.taskId+"/edit"),$scope.name=""):window.alert("创建失败："+response.message)},function(errorResponse){$scope.error=errorResponse.data.message}):window.alert("缺少一些必要信息，再检查一下吧")},$scope.remove=function(){$http["delete"]("tasks/"+$scope.task.id).success(function(){$location.path("/tasks")})},$scope.getCountries=function(){Countries.get().$promise.then(function(result){$scope.countries=result.countries})},$scope.getProvinces=function(){this.newTask?$http.get("countries/"+this.newTask.country+"/provinces").success(function(data){$scope.provinces=data.provinces}):$http.get("countries/"+this.task.country+"/provinces").success(function(data){$scope.provinces=data.provinces})},$scope.getCities=function(){$scope.newTask?$http.get("provinces/"+this.newTask.province+"/cities").success(function(data){$scope.cities=data.cities}):$http.get("provinces/"+this.task.province+"/cities").success(function(data){$scope.cities=data.cities})},$scope.getAreas=function(){$scope.newTask?$http.get("/cities/"+this.newTask.city+"/areas").success(function(data){$scope.areas=data.areas}):$http.get("/cities/"+this.task.city.id+"/areas").success(function(data){$scope.areas=data.areas})},$scope.saveProvinceAndCityAndArea=function(newCity,newProvince,newArea){newCity===$scope.task.city&&($scope.cityChangeFlag='别忘记点击"更新"哦！'),$scope.task&&($scope.task.city=newCity,$scope.task.province=newProvince,$scope.task.area=newArea),$scope.newTask&&($scope.newTask.city=newCity,$scope.newTask.province=newProvince,$scope.newTask.area=newArea)},$scope.changeSelectedByEditor=function(){$http.get("/tasks/select-task-count").success(function(data){$scope.task.selectedByEditor?(window.alert("记得点击保存。"),$scope.task.selectedByEditor=!$scope.task.selectedByEditor,$scope.task.selectedByEditorUseChinese=$scope.task.selectedByEditor?"是":"否",$scope.setSelectedTaskButtonValue=$scope.task.selectedByEditor?"取消精选":"设为精选"):0===data.statusCode?(window.alert("记得点击保存。"),$scope.task.selectedByEditor=!$scope.task.selectedByEditor,$scope.task.selectedByEditorUseChinese=$scope.task.selectedByEditor?"是":"否",$scope.setSelectedTaskButtonValue=$scope.task.selectedByEditor?"取消精选":"设为精选"):window.alert("精选任务的数量为： "+data.selectedTasksCount+" 已经满了!")})},$scope.update=function(){if($scope.task.city)if($scope.task.name){var task=$scope.task;if($scope.task.briefInfo&&($scope.task.briefInfo.tenantName||$scope.task.briefInfo.bonus?(void 0===$scope.task.briefInfo.tenantName&&delete task.briefInfo.tenantName,void 0===$scope.task.briefInfo.bonus&&delete task.briefInfo.bonus):task.briefInfo=null),delete task.restQuota,delete task.belongToScenicSpot,delete task.belongToUser,task.city&&task.city.id&&(task.city=task.city.id),task.area&&task.area.id&&(task.area=task.area.id),task.pictures&&task.pictures.length>0&&task.pictures[0].id)for(var index in task.pictures)task.pictures[index]=task.pictures[index].id;Tasks.update(task).$promise.then(function(result){0===result.statusCode?(window.alert("更新成功! 😊"),location.reload()):window.alert(result.message)})}else window.alert("缺少名称信息！~");else window.alert("请更新城市信息 😊")},$scope.addQuota=function(){TaskQuota.update({id:$scope.task.id,quantity:50}).$promise.then(function(result){0===result.statusCode?(window.alert("更新成功! 😊"),location.reload()):$scope.error=result.message})},$scope.minusQuota=function(){if($scope.task.restQuota<50){$scope.task.restQuota<50?$scope.task.restQuota:50}TaskQuota.update({id:$scope.task.id,quantity:-50}).$promise.then(function(result){0===result.statusCode?(window.alert("更新成功! 😊"),location.reload()):$scope.error=result.message})},$scope.removeTaskPicture=function(picId){$http["delete"]("pictures/"+picId+"/delete-task-picture").success(function(data){for(var index=0;index<$scope.task.pictures.length;index++)if($scope.task.pictures[index].id===picId){$scope.task.pictures.splice(index,1);break}})},$scope.setCoverUrl=function(coverUrl,task){task.coverUrl=coverUrl},$scope.selectImg=function(imgPath){$scope.selectedImg="http://7xijtn.com1.z0.glb.clouddn.com/"+imgPath;var image=new Image;image.src=$scope.selectedImg,$scope.selectedImgWidth=image.width,$scope.selectedImageHeight=image.height},$scope.find=function(keyword){var options={pageSize:$scope.itemsPerPage};keyword&&(options.keyword=keyword),Tasks.get(options).$promise.then(function(result){$scope.tasks=result.tasks,$scope.totalItems=result.total})},$scope.findByKeyword=function(keyword){$http.get("/tasks/search?keyword="+keyword,{params:{pageSize:$scope.itemsPerPage}}).success(function(result){$scope.tasks=result.tasks,$scope.totalItems=result.total}).error(function(err){$scope.error=err.message})},$scope.getTenants=function(){Users.get({role:"tenant"}).$promise.then(function(result){$scope.tenants=result.users})},$scope.getAuthedScenicSpots=function(){ScenicSpots.get({isAuthenticatedTenant:!0,pageSize:500}).$promise.then(function(result){$scope.scenicSpots=result.scenicSpots})},$scope.findScenicSpotsByKeyword=function(){ScenicSpots.get({keyword:$scope.keyword}).$promise.then(function(result){$scope.alternativeParentScenicSpot=result.scenicSpots})},$scope.setParentScenicSpot=function(scenicSpot){$scope.selectedParentScenicSpot=scenicSpot,$scope.newTask.parentScenicSpot=scenicSpot.id,delete $scope.alternativeParentScenicSpot},$scope.pageChanged=function(){Tasks.get({pageNumber:$scope.currentPage-1,pageSize:$scope.itemsPerPage}).$promise.then(function(result){$scope.tasks=result.tasks})},$scope.addTenantByKeywords=function(){$http.get("tenants/search?&keyword="+$scope.tenantKeyword,{params:{pageSize:100}}).success(function(data){$scope.tenants=data.users}).error(function(err){$scope.error=err.message})},$scope.saveTenant=function(tenant){$scope.newTask.belongToUser=tenant.id,$scope.choosedTenantName=tenant.displayName},$scope.addScenicSpotByKeywords=function(){$http.get("scenic-spots/search?keyword="+$scope.tenantKeyword,{params:{pageSize:100}}).success(function(data){$scope.scenicSpots=data.scenicSpots}).error(function(err){$scope.error=err.message})},$scope.saveScenicSpot=function(scenicSpot){$scope.newTask.belongToScenicSpot=scenicSpot.id?scenicSpot.id:scenicSpot._id,$scope.choosedScenicSpotName=scenicSpot.name},$scope.findOne=function(){Tasks.get({taskId:$stateParams.taskId}).$promise.then(function(result){$scope.task=result.task,$scope.task.selectedByEditorUseChinese=$scope.task.selectedByEditor?"是":"否",$scope.task.isActivityUseChinese=$scope.task.isActivity?"是":"否",$scope.setSelectedTaskButtonValue=$scope.task.selectedByEditor?"取消精选":"设为精选"})},$scope.initUpdateUploadController=function(){var uploader=Qiniu.uploader({runtimes:"html5,flash,html4",browse_button:"pickfiles",container:"container",drop_element:"container",flash_swf_url:"lib/plupload/js/Moxie.swf",chunk_size:"4mb",uptoken_url:"/qiniu/task-upload-token",domain:"http://7xijtn.com1.z0.glb.clouddn.com/",save_key:!0,max_file_size:"10mb",filters:[{title:"Image files",extensions:"jpg,jpeg,gif,png"}],x_vars:{taskId:$stateParams.taskId},auto_start:!0,init:{FilesAdded:function(up,files){$("table").show(),$("#success").hide(),plupload.each(files,function(file){var progress=new FileProgress(file,"fsUploadProgress");progress.setStatus("等待...")})},BeforeUpload:function(up,file){var progress=new FileProgress(file,"fsUploadProgress"),chunk_size=plupload.parseSize(this.getOption("chunk_size"));"html5"===up.runtime&&chunk_size&&progress.setChunkProgess(chunk_size)},UploadProgress:function(up,file){var progress=new FileProgress(file,"fsUploadProgress"),chunk_size=plupload.parseSize(this.getOption("chunk_size"));progress.setProgress(file.percent+"%",up.total.bytesPerSec,chunk_size)},UploadComplete:function(){$("#success").show()},FileUploaded:function(up,file,info){var infoObj=JSON.parse(info);if(infoObj.savedPicture){var picPattern={id:infoObj.savedPicture.id,coverUrl:infoObj.savedPicture.coverUrl};$scope.task.pictures.push(picPattern)}else 12001===infoObj.statusCode&&window.alert(infoObj.message);$scope.$apply();var progress=new FileProgress(file,"fsUploadProgress");progress.setComplete(up,info)},Error:function(up,err,errTip){$("table").show();var progress=new FileProgress(err.file,"fsUploadProgress");progress.setError(),progress.setStatus(errTip)}}});uploader.bind("FileUploaded",function(){})}}]),angular.module("tasks").factory("Tasks",["$resource",function($resource){return $resource("tasks/:taskId",{taskId:"@id"},{update:{method:"PUT"}})}]),angular.module("tasks").factory("TasksVerify",["$resource",function($resource){return $resource("tasks/:taskId/verify-code",{taskId:"@id"},{update:{method:"PUT"}})}]),angular.module("tasks").factory("TasksGrant",["$resource",function($resource){return $resource("tasks/:taskId/grant-awards",{taskId:"@id"},{update:{method:"PUT"}})}]),angular.module("tasks").factory("TasksQuota",["$resource",function($resource){return $resource("tasks/:taskId/add-quota",{taskId:"@id"},{update:{method:"PUT"}})}]),angular.module("user-feedbacks").run(["Menus",function(Menus){Menus.addMenuItem("topbar","用户反馈","user-feedbacks","dropdown","/user-feedbacks(/create)?",!1,["unavaliable"],12),
Menus.addSubMenuItem("topbar","user-feedbacks","用户反馈列表","user-feedbacks")}]),angular.module("user-feedbacks").config(["$stateProvider",function($stateProvider){$stateProvider.state("listUserFeedbacks",{url:"/user-feedbacks",templateUrl:"modules/user-feedbacks/views/list-user-feedbacks.client.view.html"}).state("viewUserFeedback",{url:"/user-feedbacks/:userFeedbackId",templateUrl:"modules/user-feedbacks/views/view-user-feedback.client.view.html"})}]),angular.module("user-feedbacks").controller("UserFeedbacksController",["$scope","$stateParams","$location","$http","Authentication","UserFeedbacks",function($scope,$stateParams,$location,$http,Authentication,UserFeedbacks){$scope.authentication=Authentication,$scope.create=function(){var userFeedback=new UserFeedbacks({name:this.name});userFeedback.$save(function(response){$location.path("user-feedbacks/"+response._id),$scope.name=""},function(errorResponse){$scope.error=errorResponse.data.message})},$scope.remove=function(userFeedback){if(userFeedback){userFeedback.$remove();for(var i in $scope.userFeedbacks)$scope.userFeedbacks[i]===userFeedback&&$scope.userFeedbacks.splice(i,1)}else $scope.userFeedback.$remove(function(){$location.path("user-feedbacks")})},$scope.update=function(){var userFeedback=$scope.userFeedback;userFeedback.$update(function(){$location.path("user-feedbacks/"+userFeedback._id)},function(errorResponse){$scope.error=errorResponse.data.message})},$scope.handleFeedBack=function(){$scope.userFeedback.handleTime=Date.now(),$scope.userFeedback.handler=$scope.authentication.user.id,$scope.userFeedback.user=$scope.userFeedback.user.id,$scope.userFeedback.checked=!0,$http.put("/user-feedbacks/"+$scope.userFeedback._id,$scope.userFeedback).success(function(data){0===data.statusCode&&(window.alert("更新成功! 😊"),location.reload())}).error(function(data){window.alert(data.message),$scope.error=data.message})},$scope.find=function(){$scope.userFeedbacks=UserFeedbacks.query()},$scope.findOne=function(){$scope.userFeedback=UserFeedbacks.get({userFeedbackId:$stateParams.userFeedbackId})},$scope.itemsPerPage=12,$scope.totalUncheckedItems=0,$scope.uncheckedCurrentPage=0,$scope.uncheckedScenicSpots=[],$scope.totalCheckedItems=0,$scope.checkedCurrentPage=0,$scope.checkedScenicSpots=[],$scope.getUncheckedList=function(){$http.get("/user-feedbacks",{params:{checked:"false"}}).success(function(data){console.dir(data.userFeedbacks),$scope.uncheckedUserFeedbacks=data.userFeedbacks,$scope.totalUncheckedItems=data.total}).error(function(data){$scope.error=data.message})},$scope.uncheckedPageChanged=function(){$http.get("/user-feedbacks",{params:{checked:"false",pageSize:$scope.itemsPerPage,pageNumber:$scope.uncheckedCurrentPage-1}}).success(function(data){$scope.uncheckedUserFeedbacks=data.userFeedbacks,$scope.totalUncheckedItems=data.total}).error(function(data){$scope.error=data.message})},$scope.getCheckedList=function(){$http.get("/user-feedbacks",{params:{checked:"true"}}).success(function(data){$scope.checkedUserFeedbacks=data.userFeedbacks,$scope.totalCheckedItems=data.total}).error(function(data){$scope.error=data.message})},$scope.checkedPageChanged=function(){$http.get("/user-feedbacks",{params:{checked:"true",pageSize:$scope.itemsPerPage,pageNumber:$scope.checkedCurrentPage-1}}).success(function(data){$scope.checkedUserFeedbacks=data.userFeedbacks,$scope.totalCheckedItems=data.total}).error(function(data){$scope.error=data.message})}}]),angular.module("user-feedbacks").factory("UserFeedbacks",["$resource",function($resource){return $resource("user-feedbacks/:userFeedbackId",{userFeedbackId:"@_id"},{update:{method:"PUT"}})}]),angular.module("user-management").run(["Menus",function(Menus){Menus.addMenuItem("topbar","用户管理","user-management","dropdown","/users(/create)?",!1,["admin"],11),Menus.addSubMenuItem("topbar","user-management","创建用户","users/create"),Menus.addSubMenuItem("topbar","user-management","查看商家","tenants"),Menus.addSubMenuItem("topbar","user-management","查看用户记录","user-operation-records"),Menus.addSubMenuItem("topbar","user-management","举报列表","objection-reports"),Menus.addSubMenuItem("topbar","user-management","用户反馈列表","user-feedbacks")}]),angular.module("user-management").config(["$stateProvider",function($stateProvider){$stateProvider.state("listUsers",{url:"/users",templateUrl:"modules/user-management/views/list-users.client.view.html"}).state("createUsers",{url:"/users/create",templateUrl:"modules/user-management/views/create-user.client.view.html"}).state("viewUser",{url:"/users/:userId",templateUrl:"modules/user-management/views/view-user.client.view.html"}).state("viewTenant",{url:"/tenants",templateUrl:"modules/user-management/views/list-tenant.client.view.html"}).state("viewUserOperationRecords",{url:"/user-operation-records",templateUrl:"modules/user-management/views/user-operation-records.client.view.html"})}]),angular.module("user-management").controller("UserManagementController",["$scope","$stateParams","$location","$http","Authentication",function($scope,$stateParams,$location,$http,Authentication){$scope.authentication=Authentication,$scope.users=[],$scope.userTypes=[{name:"商户",type:"tenant"},{name:"数据操作员",type:"editor"}],$scope.selectedUserType="tenant",$scope.userCount=0,$scope.itemsPerPage=10,$scope.currentPage=1,$scope.serchTenantFlag="false",$scope.createdScenicSpotsCount=0,$scope.createdSpotsCurrentPage=0,$scope.updatedScenicSpotsCount=0,$scope.updatedSpotsCurrentPage=0,$scope.selectedUser={},$scope.credentials={},$scope.newDisplayName="",$scope.saveNewDisplayName=function(newName){$http.put("/tenants/"+$scope.selectedUser.id+"/display-name",{newDisplayName:newName}).success(function(data){$scope.selectedUser.displayName=newName})},$scope.getAllUsers=function(){$http.get("users",{params:{pageSize:$scope.itemsPerPage,pageNumber:$scope.currentPage}}).success(function(data){$scope.users=data.users,$scope.userCount=data.total}).error(function(err){})},$scope.getAllTenants=function(){$http.get("/tenants",{params:{pageSize:$scope.itemsPerPage,pageNumber:$scope.currentPage-1}}).success(function(data){$scope.users=data.users,$scope.userCount=data.total}).error(function(err){})},$scope.findOne=function(){$http.get("users/"+$stateParams.userId).success(function(data){$scope.selectedUser=data.userInfo,$scope.newDisplayName=$scope.selectedUser.displayName,$http.get("/tasks?belongToUser="+$scope.selectedUser.id).success(function(data){$scope.tasks=data.tasks})})},$scope.edit=function(){},$scope.pageChanged=function(){$http.get("users",{params:{pageSize:$scope.itemsPerPage,pageNumber:$scope.currentPage-1}}).success(function(data){$scope.users=data.users,$scope.userCount=data.total})},$scope.findCreatedScenicSpots=function(){$http.get("users/"+$stateParams.userId+"/created-scenicspots").success(function(data){$scope.createdScenicSpots=data.scenicSpots,$scope.createdScenicSpotsCount=data.total})},$scope.createdScenicSpotsPageChange=function(){$http.get("users/"+$stateParams.userId+"/created-scenicspots",{params:{pageSize:$scope.itemsPerPage,pageNumber:$scope.createdSpotsCurrentPage-1}}).success(function(data){$scope.createdScenicSpots=data.scenicSpots,$scope.createdScenicSpotsCount=data.total})},$scope.findUpdatedScenicSpots=function(){$http.get("users/"+$stateParams.userId+"/updated-scenicspots").success(function(data){$scope.updatedScenicSpots=data.scenicSpots,$scope.updatedScenicSpotsCount=data.total})},$scope.updatedScenicSpotsPageChange=function(){$http.get("users/"+$stateParams.userId+"/updated-scenicspots",{params:{pageSize:$scope.itemsPerPage,pageNumber:$scope.updatedSpotsCurrentPage-1}}).success(function(data){$scope.updatedScenicSpots=data.scenicSpots,$scope.updatedScenicSpotsCount=data.total})},$scope.tenantPageChanged=function(){"true"===$scope.serchTenantFlag?$http.get("tenants/search?keyword="+$scope.keyword,{params:{pageSize:$scope.itemsPerPage,pageNumber:$scope.currentPage-1}}).success(function(data){$scope.users=data.users,$scope.userCount=data.total}).error(function(err){$scope.error=err.message}):$http.get("/tenants",{params:{pageSize:$scope.itemsPerPage,pageNumber:$scope.currentPage-1}}).success(function(data){$scope.users=data.users,$scope.userCount=data.total})},$scope.createUser=function(){"editor"===$scope.selectedUserType?$http({method:"POST",url:"users/editor",data:$scope.credentials}).success(function(){window.alert("操作员创建成功！"),$scope.credentials={}}).error(function(data){$scope.error=data.message}):"tenant"===$scope.selectedUserType&&$http({method:"POST",url:"users/tenant",data:$scope.credentials}).success(function(result){0===result.statusCode?(window.alert("商家创建成功！"),$scope.credentials={}):window.alert("创建商家失败。")}).error(function(data){$scope.error=data.message})},$scope.findTenantByKeywords=function(){$scope.serchTenantFlag="true",$http.get("tenants/search?&keyword="+$scope.keyword,{params:{pageSize:$scope.itemsPerPage,pageNumber:0}}).success(function(data){$scope.users=data.users,$scope.userCount=data.total}).error(function(err){$scope.error=err.message})},$scope.deleteTenant=function(){$http["delete"]("/tenants/"+$scope.selectedUser.id).success(function(data){9e4===data.statusCode?window.alert("发生了错误，等会再试试看吧。"):10400===data.statusCode?window.alert('该用户包含任务。请先删除任务:" '+data.task.name+' "，再删除商户！'):(window.alert("删除成功"),$location.path("/tenants"))}).error(function(err){$scope.error=err.message})}}]),angular.module("user-management").controller("UserOperationRecordersController",["$scope","$stateParams","$location","$http","Authentication",function($scope,$stateParams,$location,$http,Authentication){$scope.authentication=Authentication,$scope.beginDate=new Date,$scope.endDate=new Date,$scope.showDialog=!1,$scope.userOperationRecorders="",$scope.open=function($event){$event.preventDefault(),$event.stopPropagation(),$scope.opened=!0},$scope.disabled=function(date,mode){return"day"===mode&&(0===date.getDay()||6===date.getDay())},$scope.dateOptions={formatYear:"yyyy",formatMonth:"MM",formatDay:"dd",startingDay:1},$scope.format="yyyy/MM/dd",$scope.findUserOperationRecorders=function(){new Date($scope.beginDate).getTime()>new Date($scope.endDate).getTime()?window.alert("查询时间有问题哦~"):($scope.showDialog=!0,$http.get("/user-operation-recorders",{params:{beginDate:$scope.beginDate,endDate:$scope.endDate}}).success(function(result){$scope.userOperationRecorders=[{date:$scope.beginDate.toLocaleDateString()+" 到 "+$scope.endDate.toLocaleDateString()+" :",newDownloadCount:result.newDownloadCount?result.newDownloadCount:0,newUserCount:result.newUserCount?result.newUserCount:0,starTaskCount:result.starTaskCount,finishTaskCount:result.finishTaskCount}]}).error(function(data){window.alert(data.message),$scope.error=data.message}))}}]),angular.module("users").config(["$httpProvider",function($httpProvider){$httpProvider.interceptors.push(["$q","$location","Authentication",function($q,$location,Authentication){return{responseError:function(rejection){switch(rejection.status){case 401:Authentication.user=null,$location.path("signin");break;case 403:}return $q.reject(rejection)}}}])}]),angular.module("users").config(["$stateProvider",function($stateProvider){$stateProvider.state("profile",{url:"/settings/profile",templateUrl:"modules/users/views/settings/edit-profile.client.view.html"}).state("password",{url:"/settings/password",templateUrl:"modules/users/views/settings/change-password.client.view.html"}).state("accounts",{url:"/settings/accounts",templateUrl:"modules/users/views/settings/social-accounts.client.view.html"}).state("signup",{url:"/signup",templateUrl:"modules/users/views/authentication/signup.client.view.html"}).state("signin",{url:"/signin",templateUrl:"modules/users/views/authentication/signin.client.view.html"}).state("forgot",{url:"/password/forgot",templateUrl:"modules/users/views/password/forgot-password.client.view.html"}).state("reset-invalid",{url:"/password/reset/invalid",templateUrl:"modules/users/views/password/reset-password-invalid.client.view.html"}).state("reset-success",{url:"/password/reset/success",templateUrl:"modules/users/views/password/reset-password-success.client.view.html"}).state("reset",{url:"/password/reset/:token",templateUrl:"modules/users/views/password/reset-password.client.view.html"})}]),angular.module("users").controller("AuthenticationController",["$scope","$http","$http","$location","Authentication",function($scope,$http,$httpProvider,$location,Authentication){$scope.authentication=Authentication,$scope.authentication.user&&$location.path("/"),$scope.signup=function(){$http.post("/auth/signup",$scope.credentials).success(function(response){$scope.authentication.user=response.user,$location.path("/")}).error(function(response){$scope.error=response.message})},$scope.signin=function(){$http.post("/auth/signin-web",$scope.credentials).success(function(response){if(0!==response.statusCode)$scope.error=response.message;else{if($scope.authentication.user=response.user,-1!==response.user.roles.indexOf("tenant"))return $location.path("/my-activity-list");$location.path("/")}})}}]),angular.module("users").controller("PasswordController",["$scope","$stateParams","$http","$location","Authentication",function($scope,$stateParams,$http,$location,Authentication){$scope.authentication=Authentication,$scope.authentication.user&&$location.path("/"),$scope.askForPasswordReset=function(){$scope.success=$scope.error=null,$http.post("/auth/forgot",$scope.credentials).success(function(response){$scope.credentials=null,$scope.success=response.message}).error(function(response){$scope.credentials=null,$scope.error=response.message})},$scope.resetUserPassword=function(){$scope.success=$scope.error=null,$http.post("/auth/reset/"+$stateParams.token,$scope.passwordDetails).success(function(response){$scope.passwordDetails=null,Authentication.user=response,$location.path("/password/reset/success")}).error(function(response){$scope.error=response.message})}}]),angular.module("users").controller("SettingsController",["$scope","$http","$location","Users","Authentication",function($scope,$http,$location,Users,Authentication){$scope.user=Authentication.user,$scope.user||$location.path("/"),$scope.hasConnectedAdditionalSocialAccounts=function(provider){for(var i in $scope.user.additionalProvidersData)return!0;return!1},$scope.isConnectedSocialAccount=function(provider){return $scope.user.provider===provider||$scope.user.additionalProvidersData&&$scope.user.additionalProvidersData[provider]},$scope.removeUserSocialAccount=function(provider){$scope.success=$scope.error=null,$http["delete"]("/users/accounts",{params:{provider:provider}}).success(function(response){$scope.success=!0,$scope.user=Authentication.user=response}).error(function(response){$scope.error=response.message})},$scope.updateUserProfile=function(isValid){if(isValid){$scope.success=$scope.error=null;var user=new Users($scope.user);user.$update(function(response){console.log(response),0===response.statusCode&&($scope.success=!0)},function(response){$scope.error=response.data.message})}else $scope.submitted=!0},$scope.changeUserPassword=function(){$scope.success=$scope.error=null,$http.post("/users/password",$scope.passwordDetails).success(function(response){window.alert("密码修改成功！请重新登陆"),Authentication.user=null,$location.path("/signin")}).error(function(response){$scope.error=response.message})}}]),angular.module("users").factory("Authentication",[function(){var _this=this;return _this._data={user:window.user},_this._data}]),angular.module("users").factory("Users",["$resource",function($resource){return $resource("users",{},{update:{method:"PUT"}})}]);